<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<title>Remote Key Control Panel / Control de Teclas Remoto</title>
  <!-- Bootstrap CSS desde CDN -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-..."
    crossorigin="anonymous">
  <style>
    body { padding: 1rem; }
    .btn-custom { flex: 1 1 30%; margin: .5rem; min-width: 100px; }
    .grid { display: flex; flex-wrap: wrap; justify-content: center; }
    #configBtn {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1050;
    }
  </style>
</head>
<body>

  <button id="configBtn" class="btn btn-secondary" data-bs-toggle="offcanvas" data-bs-target="#configPanel" aria-controls="configPanel">\u2699</button>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="configPanel" aria-labelledby="configPanelLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="configPanelLabel">Configuraci\u00f3n</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      {% for id, data in buttons.items() %}
        <form class="mb-4" data-btn="{{ id }}">
          <h6 class="mb-2">Bot\u00f3n {{ id }}</h6>
          <div class="mb-2">
            <label class="form-label">Etiqueta / Label</label>
            <input type="text" class="form-control label-input" value="{{ data.label }}">
          </div>
          <div class="mb-2">
            <label class="form-label">Fondo</label>
            <div class="form-check">
              <input class="form-check-input bg-choice" type="radio" name="bg_{{ id }}" id="bgImage{{ id }}" value="image" {% if data.image %}checked{% endif %}>
              <label class="form-check-label" for="bgImage{{ id }}">Imagen</label>
            </div>
            <div class="form-check">
              <input class="form-check-input bg-choice" type="radio" name="bg_{{ id }}" id="bgColor{{ id }}" value="color" {% if data.color and not data.image %}checked{% endif %}>
              <label class="form-check-label" for="bgColor{{ id }}">Color</label>
            </div>
          </div>
          <div class="mb-2 image-group {% if not data.image %}d-none{% endif %}">
            <label class="form-label">URL de imagen</label>
            <input type="text" class="form-control" value="{{ data.image or '' }}">
          </div>
          <div class="mb-2 color-group {% if data.image %}d-none{% endif %}">
            <label class="form-label">Color</label>
            <input type="color" class="form-control form-control-color" value="{{ data.color or '#ffffff' }}">
          </div>
          <div class="mb-2">
            <label class="form-label">Secuencia / Sequence</label>
            <input type="text" class="form-control" value="{{ data.seq | join(' ') }}">
          </div>
        </form>
      {% endfor %}
    </div>
  </div>

  <h1 class="text-center mb-4">Panel de Control de Teclas / Remote Key Control Panel</h1>
  <div class="grid">
    {% for id, data in buttons.items() %}
      <button
        class="btn btn-primary btn-custom"
        onclick="sendPress('{{ id }}')"
        data-btn="{{ id }}"
        {% if data.image or data.color %}
          style="{% if data.image %}background-image: url('{{ data.image }}'); background-size: cover;{% endif %}{% if data.color %} background-color: {{ data.color }};{% endif %}"
        {% endif %}>
        <span class="btn-label">{{ data.label }}</span><br>
        <small>{{ data.seq | join(' + ') }}</small>
      </button>
    {% endfor %}
  </div>

  <script>
    function sendPress(id) {
      fetch(`/press/${id}`, { method: 'POST' })
        .then(r => r.json())
        .then(resp => {
          if (resp.status === 'ok') {
            console.log(`Pulsadas: ${resp.pressed.join(', ')} / Pressed: ${resp.pressed.join(', ')}`);
          } else {
            alert('Error: ' + resp.message);
          }
        })
        .catch(err => {
          console.error(err);
          alert('No se pudo conectar al servidor / Could not connect to the server.');
        });
    }

    // Load saved labels and update in real time
    document.querySelectorAll('form[data-btn]').forEach(form => {
      const id = form.dataset.btn;
      const input = form.querySelector('.label-input');
      const saved = localStorage.getItem('label_' + id);
      const labelSpan = document.querySelector(`button[data-btn="${id}"] .btn-label`);
      if (saved) {
        input.value = saved;
        if (labelSpan) labelSpan.textContent = saved;
      }
      input.addEventListener('input', e => {
        localStorage.setItem('label_' + id, e.target.value);
        if (labelSpan) labelSpan.textContent = e.target.value;
      });
    });

    document.querySelectorAll('.bg-choice').forEach(radio => {
      radio.addEventListener('change', e => {
        const form = e.target.closest('form');
        form.querySelector('.image-group').classList.toggle('d-none', e.target.value !== 'image');
        form.querySelector('.color-group').classList.toggle('d-none', e.target.value !== 'color');
      });
    });
</script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-..." crossorigin="anonymous"></script>

</body>
</html>
