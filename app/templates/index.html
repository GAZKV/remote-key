<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<title>Remote Key Control Panel / Control de Teclas Remoto</title>
  <!-- Bootstrap CSS desde CDN -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-..."
    crossorigin="anonymous">
  <style>
    body { padding: 1rem; }
    .btn-custom {
      width: 100%;
      margin: 0;
      aspect-ratio: 1 / 1;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: .5rem;
      justify-items: center;
    }
    #configBtn {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1050;
    }
  </style>
</head>
<body>

  <button id="configBtn" class="btn btn-secondary" data-bs-toggle="offcanvas" data-bs-target="#configPanel" aria-controls="configPanel">\u2699</button>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="configPanel" aria-labelledby="configPanelLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="configPanelLabel">Configuraci\u00f3n</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body" id="configContainer">
      <!-- Forms will be injected here -->
    </div>
    </div>

  <h1 class="text-center mb-4">Panel de Control de Teclas / Remote Key Control Panel</h1>
    <div class="grid" id="buttonGrid"></div>

  <script>
    function sendPress(id) {
      const btn = document.querySelector(`[data-btn="${id}"]`);
      const seq = btn?.dataset.seq || '';
      fetch(`/press/${id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ seq })
      })
        .then(r => r.json())
        .then(resp => {
          if (resp.status === 'ok') {
            console.log(`Pulsadas: ${resp.pressed.join(', ')} / Pressed: ${resp.pressed.join(', ')}`);
          } else {
            alert('Error: ' + resp.message);
          }
        })
        .catch(err => {
          console.error(err);
          alert('No se pudo conectar al servidor / Could not connect to the server.');
        });
    }

    function saveConfig(id, cfg) {
      localStorage.setItem('config_' + id, JSON.stringify(cfg));
    }

    function loadConfig(id) {
      try {
        return JSON.parse(localStorage.getItem('config_' + id) || 'null');
      } catch (e) {
        return null;
      }
    }
    const defaults = {{ buttons | tojson }};

    function createButton(id, cfg) {
      const btn = document.createElement('button');
      btn.className = 'btn btn-primary btn-custom';
      btn.dataset.btn = id;
      btn.dataset.seq = (cfg.seq || []).join(' ');
      btn.onclick = () => sendPress(id);
      if (cfg.image) {
        btn.style.backgroundImage = `url('${cfg.image}')`;
        btn.style.backgroundSize = 'cover';
      } else if (cfg.color) {
        btn.style.backgroundColor = cfg.color;
      }
      btn.innerHTML = `<span class="btn-label">${cfg.label}</span><br><small class="seq-display">${(cfg.seq || []).join(' + ')}</small>`;
      return btn;
    }

    function createForm(id, cfg) {
      const form = document.createElement('form');
      form.className = 'mb-4';
      form.dataset.btn = id;
      const bgType = cfg.bg || (cfg.image ? 'image' : 'color');
      form.innerHTML = `
          <h6 class="mb-2">Bot\u00f3n ${id}</h6>
          <div class="mb-2">
            <label class="form-label">Etiqueta / Label</label>
            <input type="text" class="form-control label-input" value="${cfg.label}">
          </div>
          <div class="mb-2">
            <label class="form-label">Fondo</label>
            <select class="form-select bg-choice">
              <option value="image"${bgType === 'image' ? ' selected' : ''}>Imagen</option>
              <option value="color"${bgType === 'color' ? ' selected' : ''}>Color</option>
            </select>
          </div>
          <div class="mb-2 image-group${bgType === 'image' ? '' : ' d-none'}">
            <label class="form-label">URL de imagen</label>
            <input type="text" class="form-control" value="${cfg.image || ''}">
          </div>
          <div class="mb-2 color-group${bgType === 'color' ? '' : ' d-none'}">
            <label class="form-label">Color</label>
            <input type="color" class="form-control form-control-color" value="${cfg.color || '#ffffff'}">
          </div>
          <div class="mb-2">
            <label class="form-label">Secuencia / Sequence</label>
            <input type="text" class="form-control seq-input" value="${(cfg.seq || []).join(' ')}">
          </div>`;
      return form;
    }

    function setupForm(form, button, id) {
      const labelInput = form.querySelector('.label-input');
      const bgSelect = form.querySelector('.bg-choice');
      const imgInput = form.querySelector('.image-group input');
      const colorInput = form.querySelector('.color-group input');
      const seqInput = form.querySelector('.seq-input');

      const labelSpan = button.querySelector('.btn-label');
      const seqDisplay = button.querySelector('.seq-display');

      const toggleGroups = () => {
        form.querySelector('.image-group').classList.toggle('d-none', bgSelect.value !== 'image');
        form.querySelector('.color-group').classList.toggle('d-none', bgSelect.value !== 'color');
      };

      const applyStyles = () => {
        button.style.backgroundImage = '';
        button.style.backgroundColor = '';
        if (bgSelect.value === 'image' && imgInput.value) {
          button.style.backgroundImage = `url('${imgInput.value}')`;
          button.style.backgroundSize = 'cover';
        } else if (bgSelect.value === 'color') {
          button.style.backgroundColor = colorInput.value;
        }
      };

      const saveCurrent = () => {
        saveConfig(id, {
          label: labelInput.value.trim(),
          bg: bgSelect.value,
          image: imgInput.value.trim(),
          color: colorInput.value,
          seq: seqInput.value.trim()
        });
      };

      labelSpan.textContent = labelInput.value;
      seqDisplay.textContent = seqInput.value.split(' ').join(' + ');
      button.dataset.seq = seqInput.value.trim();

      toggleGroups();
      applyStyles();

      if (seqInput.value.trim()) {
        fetch(`/config/${id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ seq: seqInput.value.trim() })
        }).catch(() => {});
      }

      labelInput.addEventListener('input', () => {
        labelSpan.textContent = labelInput.value;
        saveCurrent();
      });

      bgSelect.addEventListener('change', () => {
        toggleGroups();
        applyStyles();
        saveCurrent();
      });

      imgInput.addEventListener('input', () => {
        applyStyles();
        saveCurrent();
      });

      colorInput.addEventListener('input', () => {
        applyStyles();
        saveCurrent();
      });

        seqInput.addEventListener('change', () => {
          const seq = seqInput.value.trim();
          fetch(`/config/${id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ seq })
          })
            .then(r => r.json())
            .then(resp => {
              if (resp.status === 'ok') {
                seqDisplay.textContent = seq.split(' ').join(' + ');
                button.dataset.seq = seq;
              }
            })
            .catch(() => {});
          saveCurrent();
        });
    }

    window.addEventListener('DOMContentLoaded', () => {
      const configContainer = document.getElementById('configContainer');
      const grid = document.getElementById('buttonGrid');
      Object.keys(defaults).forEach(id => {
        const saved = loadConfig(id) || {};
        const cfg = {
          label: saved.label || defaults[id].label,
          image: saved.image !== undefined ? saved.image : defaults[id].image,
          color: saved.color !== undefined ? saved.color : defaults[id].color,
          seq: saved.seq ? saved.seq.trim().split(/\s+/) : defaults[id].seq,
          bg: saved.bg || (saved.image ? 'image' : (saved.color ? 'color' : (defaults[id].image ? 'image' : 'color')))
        };
        const button = createButton(id, cfg);
        grid.appendChild(button);
        const form = createForm(id, cfg);
        configContainer.appendChild(form);
        setupForm(form, button, id);
      });
    });

</script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-..." crossorigin="anonymous"></script>

</body>
</html>
