<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<title>Remote Key Control Panel / Control de Teclas Remoto</title>
  <!-- Bootstrap CSS desde CDN -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-..."
    crossorigin="anonymous">
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
    rel="stylesheet">
  <style>
    body { padding: 1rem; }
    .btn-custom {
      width: 100%;
      margin: 0;
      padding: .25rem;
      aspect-ratio: 1 / 1;
      border-radius: .5rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      transition: background-color .2s, box-shadow .2s, transform .1s;
      font-size: clamp(0.75rem, 2.5vw, 1.25rem);
    }

    @keyframes pressBounce {
      0% { transform: scale(1); }
      40% { transform: scale(0.9); }
      100% { transform: scale(1); }
    }

    .btn-custom:active {
      transform: scale(0.96);
    }

    .btn-custom.active-anim {
      animation: pressBounce 0.2s ease;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(clamp(80px, 20vw, 160px), 1fr));
      gap: .5rem;
      justify-items: center;
    }
    @media (min-width: 1400px) {
      .grid {
        grid-template-columns: repeat(6, 1fr);
      }
    }
    @media (max-width: 576px) {
      .grid {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      }
    }
    #configBtn {
      position: fixed;
      top: 1rem;
      right: 1rem;
      z-index: 1050;
    }
  </style>
</head>
<body>
  <div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3"></div>

  <button id="configBtn" class="btn btn-secondary" data-bs-toggle="offcanvas" data-bs-target="#configPanel" aria-controls="configPanel">⚙</button>

  <div class="offcanvas offcanvas-end" tabindex="-1" id="configPanel" aria-labelledby="configPanelLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="configPanelLabel">Configuración</h5>
      <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body" id="configContainer">
      <div class="mb-3">
        <label class="form-label">Perfil</label>
        <div class="input-group">
          <select id="profileSelect" class="form-select"></select>
          <button id="newProfileBtn" class="btn btn-outline-success" type="button" title="Nuevo perfil">
            <i class="bi bi-plus"></i>
          </button>
          <button id="deleteProfileBtn" class="btn btn-outline-danger" type="button" title="Eliminar perfil">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
      <button id="addButton" type="button" class="btn btn-success w-100 mb-3">Añadir nuevo botón</button>
      <button id="exportBtn" type="button" class="btn btn-outline-primary w-100 mb-3">Descargar configuración</button>
      <input id="importFile" type="file" accept="application/json" class="d-none">
      <button id="importBtn" type="button" class="btn btn-outline-secondary w-100 mb-3">Cargar configuración</button>
      <!-- Forms will be injected here -->
    </div>
    </div>

  <!-- <h1 class="text-center mb-4">Panel de Control de Teclas / Remote Key Control Panel</h1>-->
    <div class="grid" id="buttonGrid"></div>

    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirmar eliminación</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            ¿Eliminar este botón?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteYes">Eliminar</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="confirmCriticalModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Confirmar acción</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            ¿Ejecutar esta acción crítica?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="confirmCriticalYes">Aceptar</button>
          </div>
        </div>
      </div>
    </div>

  <script>
    function playEffect(button) {
      if (!button) return;
      const eff = button.dataset.effect || 'anim';
      if (eff === 'sound') {
        const snd = button.dataset.sound;
        if (snd) {
          const audio = new Audio(snd);
          audio.play().catch(() => {});
        }
      } else if (eff === 'anim') {
        button.classList.add('active-anim');
        setTimeout(() => button.classList.remove('active-anim'), 200);
      }
    }
    function showToast(message, variant = "success") {
      const container = document.getElementById("toastContainer");
      const toastEl = document.createElement("div");
      toastEl.className = `toast align-items-center text-bg-${variant} border-0`;
      toastEl.setAttribute("role", "alert");
      toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
      container.appendChild(toastEl);
      const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
      toastEl.addEventListener("hidden.bs.toast", () => toastEl.remove());
      toast.show();
    }
    function sendPress(id) {
      const btn = document.querySelector(`[data-btn="${id}"]`);
      const type = btn?.dataset.type || 'keys';
      const seq = btn?.dataset.seq || '';
      const cmd = btn?.dataset.cmd || '';
      const method = btn?.dataset.method || 'GET';
      const url = btn?.dataset.url || '';
      const bodyData = btn?.dataset.body || '';
      const critical = btn?.dataset.critical === 'true';
      if (critical) {
        confirmCritical().then(accepted => {
          if (accepted) doSend();
        });
        return;
      }
      doSend();
      function doSend() {
      if (type === 'shell') {
        if (!cmd) return;
        if (!confirm(`Ejecutar comando:\n${cmd}?`)) return;
      }
      fetch(`/press/${id}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ type, seq, cmd, method, url, body: bodyData })
      })
        .then(r => r.json())
        .then(resp => {
          if (resp.status === 'ok') {
            playEffect(btn);
            if (type === 'http') {
              showToast(`HTTP ${method} -> ${resp.status_code}`);
            } else {
              //showToast('Acción ejecutada / Action executed');
              console.log(`Pulsadas: ${resp.pressed.join(', ')} / Pressed: ${resp.pressed.join(', ')}`);
            }
          } else {
            showToast('Error: ' + resp.message, 'danger');
          }
        })
        .catch(err => {
          console.error(err);
          showToast('No se pudo conectar al servidor / Could not connect to the server.', 'danger');
        });
      }
    }

    function getProfiles() {
      try {
        return JSON.parse(localStorage.getItem('profiles') || 'null');
      } catch (e) {
        return null;
      }
    }

    function saveProfiles(list) {
      localStorage.setItem('profiles', JSON.stringify(list));
    }

    function getCurrentProfile() {
      return localStorage.getItem('current_profile') || 'default';
    }

    function setCurrentProfile(name) {
      localStorage.setItem('current_profile', name);
    }

    function storageKey(base) {
      const p = getCurrentProfile();
      return p === 'default' ? base : `profile_${p}_${base}`;
    }

    function saveConfig(id, cfg) {
      localStorage.setItem(storageKey('config_' + id), JSON.stringify(cfg));
    }

    function loadConfig(id) {
      try {
        return JSON.parse(localStorage.getItem(storageKey('config_' + id)) || 'null');
      } catch (e) {
        return null;
      }
    }

    function confirmDeletion() {
      const modalEl = document.getElementById('confirmDeleteModal');
      const modal = new bootstrap.Modal(modalEl);
      const yesBtn = document.getElementById('confirmDeleteYes');
      return new Promise(resolve => {
        let confirmed = false;
        const onConfirm = () => {
          confirmed = true;
          bootstrap.Modal.getInstance(modalEl).hide();
        };
        const onHidden = () => {
          cleanup();
          resolve(confirmed);
        };
        function cleanup() {
          yesBtn.removeEventListener('click', onConfirm);
          modalEl.removeEventListener('hidden.bs.modal', onHidden);
        }
        yesBtn.addEventListener('click', onConfirm, { once: true });
        modalEl.addEventListener('hidden.bs.modal', onHidden, { once: true });
      modal.show();
    });
  }

  function confirmCritical() {
    const modalEl = document.getElementById('confirmCriticalModal');
    const modal = new bootstrap.Modal(modalEl);
    const yesBtn = document.getElementById('confirmCriticalYes');
    return new Promise(resolve => {
      let confirmed = false;
      const onConfirm = () => {
        confirmed = true;
        bootstrap.Modal.getInstance(modalEl).hide();
      };
      const onHidden = () => {
        cleanup();
        resolve(confirmed);
      };
      function cleanup() {
        yesBtn.removeEventListener('click', onConfirm);
        modalEl.removeEventListener('hidden.bs.modal', onHidden);
      }
      yesBtn.addEventListener('click', onConfirm, { once: true });
      modalEl.addEventListener('hidden.bs.modal', onHidden, { once: true });
      modal.show();
    });
  }
  const defaults = {{ buttons | tojson }};

    function createButton(id, cfg) {
      const btn = document.createElement('button');
      btn.className = 'btn btn-primary btn-custom';
      btn.dataset.btn = id;
      btn.dataset.type = cfg.type || 'keys';
      btn.dataset.seq = (cfg.seq || []).join('\n');
      btn.dataset.cmd = cfg.cmd || '';
      btn.dataset.method = cfg.method || 'GET';
      btn.dataset.url = cfg.url || '';
      btn.dataset.body = cfg.body || '';
      btn.dataset.effect = cfg.effect || 'anim';
      btn.dataset.sound = cfg.sound || '';
      btn.dataset.critical = cfg.critical ? 'true' : 'false';
      btn.dataset.image = cfg.image || '';
      btn.onclick = () => sendPress(id);
      if (cfg.image) {
        btn.style.backgroundImage = `url('${cfg.image}')`;
        btn.style.backgroundSize = 'cover';
      } else if (cfg.color) {
        btn.style.backgroundColor = cfg.color;
      }
      let display;
      if (btn.dataset.type === 'shell') {
        display = cfg.cmd || '';
      } else if (btn.dataset.type === 'http') {
        display = `${cfg.method || 'GET'} ${cfg.url || ''}`;
      } else {
        display = (cfg.seq || []).join(' + ');
      }
      btn.innerHTML = `<span class="btn-label">${cfg.label}</span><br><small class="seq-display">${display}</small>`;
      return btn;
    }

    function createForm(id, cfg) {
      const form = document.createElement('form');
      form.className = 'mb-4';
      form.dataset.btn = id;
      const bgType = cfg.bg || (cfg.image ? 'image' : 'color');
      form.innerHTML = `
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Botón ${id}</h6>
            <button type="button" class="btn btn-outline-danger btn-sm delete-btn">
              <i class="bi bi-trash"></i>
            </button>
          </div>
          <div class="mb-2">
            <label class="form-label">Etiqueta / Label</label>
            <input type="text" class="form-control label-input" value="${cfg.label}">
          </div>
          <div class="mb-2">
            <label class="form-label">Tipo de acción</label>
            <select class="form-select action-type">
              <option value="keys"${(cfg.type || 'keys') === 'keys' ? ' selected' : ''}>Secuencia de teclas</option>
              <option value="shell"${cfg.type === 'shell' ? ' selected' : ''}>Comando shell</option>
              <option value="http"${cfg.type === 'http' ? ' selected' : ''}>Petición HTTP</option>
            </select>
          </div>
          <div class="mb-2">
            <label class="form-label">Fondo</label>
            <select class="form-select bg-choice">
              <option value="image"${bgType === 'image' ? ' selected' : ''}>Imagen</option>
              <option value="color"${bgType === 'color' ? ' selected' : ''}>Color</option>
            </select>
          </div>
          <div class="mb-2 image-group${bgType === 'image' ? '' : ' d-none'}">
            <label class="form-label">Imagen</label>
            <input type="file" class="form-control img-file mb-2" accept="image/*">
            <input type="text" class="form-control img-input" value="${cfg.image || ''}" placeholder="URL o base64">
          </div>
          <div class="mb-2 color-group${bgType === 'color' ? '' : ' d-none'}">
            <label class="form-label">Color</label>
            <input type="color" class="form-control form-control-color" value="${cfg.color || '#ffffff'}">
          </div>
          <div class="mb-2 effect-group">
            <label class="form-label">Efecto</label>
            <select class="form-select effect-select">
              <option value="anim"${!cfg.effect || cfg.effect === 'anim' ? ' selected' : ''}>Animación</option>
              <option value="sound"${cfg.effect === 'sound' ? ' selected' : ''}>Sonido</option>
              <option value="none"${cfg.effect === 'none' ? ' selected' : ''}>Ninguno</option>
            </select>
            <input type="file" class="form-control sound-file mt-2${cfg.effect === 'sound' ? '' : ' d-none'}" accept="audio/*">
            <input type="text" class="form-control sound-input mt-2${cfg.effect === 'sound' ? '' : ' d-none'}" value="${cfg.sound || ''}" placeholder="URL o base64">
          </div>
          <div class="form-check form-switch mb-2">
            <input type="checkbox" class="form-check-input critical-check"${cfg.critical ? ' checked' : ''}>
            <label class="form-check-label">Acción crítica</label>
          </div>
          <div class="mb-2 seq-group${(cfg.type || 'keys') === 'keys' ? '' : ' d-none'}">
            <label class="form-label">Secuencia / Sequence</label>
            <textarea class="form-control seq-input" rows="3">${(cfg.seq || []).join('\n')}</textarea>
            <div class="form-text">Ej: <code>ctrl+c wait 500 ctrl+v</code> &mdash; usa <code>wait &lt;ms&gt;</code> para pausar. Teclas especiales: <code>f1</code>&ndash;<code>f12</code>, <code>left_click</code>, <code>right_click</code>, <code>numpad_0</code>&ndash;<code>numpad_9</code>.</div>
          </div>
          <div class="mb-2 cmd-group${cfg.type === 'shell' ? '' : ' d-none'}">
            <label class="form-label">Comando</label>
            <input type="text" class="form-control cmd-input" value="${cfg.cmd || ''}">
          </div>
          <div class="mb-2 http-group${cfg.type === 'http' ? '' : ' d-none'}">
            <label class="form-label">URL</label>
            <input type="text" class="form-control url-input" value="${cfg.url || ''}">
            <label class="form-label mt-2">Método</label>
            <input type="text" class="form-control method-input" value="${cfg.method || 'GET'}">
            <label class="form-label mt-2">Payload</label>
            <textarea class="form-control body-input" rows="2">${cfg.body || ''}</textarea>
          </div>`;
      return form;
    }

    function setupForm(form, button, id) {
      const labelInput = form.querySelector('.label-input');
      const bgSelect = form.querySelector('.bg-choice');
      const imgInput = form.querySelector('.img-input');
      const imgFile = form.querySelector('.img-file');
      const colorInput = form.querySelector('.color-group input');
      const effectSelect = form.querySelector('.effect-select');
      const soundInput = form.querySelector('.sound-input');
      const soundFile = form.querySelector('.sound-file');
      const typeSelect = form.querySelector('.action-type');
      const seqInput = form.querySelector('.seq-input');
      const cmdInput = form.querySelector('.cmd-input');
      const urlInput = form.querySelector('.url-input');
      const methodInput = form.querySelector('.method-input');
      const bodyInput = form.querySelector('.body-input');
      const criticalCheck = form.querySelector('.critical-check');
      const seqGroup = form.querySelector('.seq-group');
      const cmdGroup = form.querySelector('.cmd-group');
      const httpGroup = form.querySelector('.http-group');
      const deleteBtn = form.querySelector('.delete-btn');

      const labelSpan = button.querySelector('.btn-label');
      const seqDisplay = button.querySelector('.seq-display');

      const toggleGroups = () => {
        form.querySelector('.image-group').classList.toggle('d-none', bgSelect.value !== 'image');
        form.querySelector('.color-group').classList.toggle('d-none', bgSelect.value !== 'color');
        soundInput.classList.toggle('d-none', effectSelect.value !== 'sound');
        soundFile.classList.toggle('d-none', effectSelect.value !== 'sound');
        seqGroup.classList.toggle('d-none', typeSelect.value !== 'keys');
        cmdGroup.classList.toggle('d-none', typeSelect.value !== 'shell');
        httpGroup.classList.toggle('d-none', typeSelect.value !== 'http');
      };

      const applyStyles = () => {
        button.style.backgroundImage = '';
        button.style.backgroundColor = '';
        if (bgSelect.value === 'image' && imgInput.value) {
          button.style.backgroundImage = `url('${imgInput.value}')`;
          button.style.backgroundSize = 'cover';
        } else if (bgSelect.value === 'color') {
          button.style.backgroundColor = colorInput.value;
        }
      };

      const saveCurrent = () => {
        saveConfig(id, {
          label: labelInput.value.trim(),
          bg: bgSelect.value,
          image: imgInput.value.trim(),
          color: colorInput.value,
          type: typeSelect.value,
          seq: seqInput.value.trim(),
          cmd: cmdInput.value.trim(),
          method: methodInput.value.trim(),
          url: urlInput.value.trim(),
          body: bodyInput.value,
          critical: criticalCheck.checked,
          effect: effectSelect.value,
          sound: soundInput.value.trim()
        });
        fetch(`/config/${id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: typeSelect.value,
            seq: seqInput.value.trim(),
            cmd: cmdInput.value.trim(),
            method: methodInput.value.trim(),
            url: urlInput.value.trim(),
            body: bodyInput.value,
            image: imgInput.value.trim(),
            color: colorInput.value,
            critical: criticalCheck.checked,
            effect: effectSelect.value,
            sound: soundInput.value.trim()
          })
        }).catch(() => {});
      };

        if (deleteBtn) {
          deleteBtn.addEventListener('click', async () => {
            const confirmed = await confirmDeletion();
            if (!confirmed) return;
            form.remove();
            button.remove();
            localStorage.removeItem(storageKey('config_' + id));
            const ids = getIdList() || [];
            const idx = ids.indexOf(id);
            if (idx !== -1) {
              ids.splice(idx, 1);
              saveIdList(ids);
            }
            fetch(`/config/${id}`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ seq: '' })
            }).catch(() => {});
          });
        }

      labelSpan.textContent = labelInput.value;
      if (typeSelect.value === 'shell') {
        seqDisplay.textContent = cmdInput.value;
      } else if (typeSelect.value === 'http') {
        seqDisplay.textContent = `${methodInput.value.trim()} ${urlInput.value.trim()}`;
      } else {
        seqDisplay.textContent = seqInput.value.split(/\s+/).join(' + ');
      }
      button.dataset.seq = seqInput.value.trim();
      button.dataset.type = typeSelect.value;
      button.dataset.cmd = cmdInput.value.trim();
      button.dataset.method = methodInput.value.trim();
      button.dataset.url = urlInput.value.trim();
      button.dataset.body = bodyInput.value;
      button.dataset.effect = effectSelect.value;
      button.dataset.sound = soundInput.value.trim();
      button.dataset.critical = criticalCheck.checked;

      toggleGroups();
      applyStyles();

      if (seqInput.value.trim() || cmdInput.value.trim() || urlInput.value.trim()) {
        fetch(`/config/${id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: typeSelect.value,
            seq: seqInput.value.trim(),
            cmd: cmdInput.value.trim(),
            method: methodInput.value.trim(),
            url: urlInput.value.trim(),
            body: bodyInput.value,
            effect: effectSelect.value,
            sound: soundInput.value.trim()
          })
        }).catch(() => {});
      }

      labelInput.addEventListener('input', () => {
        labelSpan.textContent = labelInput.value;
        saveCurrent();
      });

      typeSelect.addEventListener('change', () => {
        toggleGroups();
        if (typeSelect.value === 'shell') {
          seqDisplay.textContent = cmdInput.value;
        } else if (typeSelect.value === 'http') {
          seqDisplay.textContent = `${methodInput.value.trim()} ${urlInput.value.trim()}`;
        } else {
          seqDisplay.textContent = seqInput.value.split(/\s+/).join(' + ');
        }
        button.dataset.type = typeSelect.value;
        saveCurrent();
      });

      bgSelect.addEventListener('change', () => {
        toggleGroups();
        applyStyles();
        saveCurrent();
      });

      imgInput.addEventListener('input', () => {
        button.dataset.image = imgInput.value.trim();
        applyStyles();
        saveCurrent();
      });

      if (imgFile) {
        imgFile.addEventListener('change', () => {
          if (!imgFile.files.length) return;
          const reader = new FileReader();
          reader.onload = () => {
            imgInput.value = reader.result;
            button.dataset.image = reader.result;
            applyStyles();
            saveCurrent();
          };
          reader.readAsDataURL(imgFile.files[0]);
        });
      }

      colorInput.addEventListener('input', () => {
        applyStyles();
        saveCurrent();
      });

      effectSelect.addEventListener('change', () => {
        toggleGroups();
        button.dataset.effect = effectSelect.value;
        saveCurrent();
      });

      soundInput.addEventListener('input', () => {
        button.dataset.sound = soundInput.value.trim();
        saveCurrent();
      });

      criticalCheck.addEventListener('change', () => {
        button.dataset.critical = criticalCheck.checked;
        saveCurrent();
      });

      if (soundFile) {
        soundFile.addEventListener('change', () => {
          if (!soundFile.files.length) return;
          const reader = new FileReader();
          reader.onload = () => {
            soundInput.value = reader.result;
            button.dataset.sound = reader.result;
            saveCurrent();
          };
          reader.readAsDataURL(soundFile.files[0]);
        });
      }

      seqInput.addEventListener('change', () => {
        const seq = seqInput.value.trim();
        fetch(`/config/${id}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            type: typeSelect.value,
            seq,
            cmd: cmdInput.value.trim(),
            method: methodInput.value.trim(),
            url: urlInput.value.trim(),
            body: bodyInput.value,
            effect: effectSelect.value,
            sound: soundInput.value.trim()
          })
        })
          .then(r => r.json())
          .then(resp => {
            if (resp.status === 'ok') {
              if (typeSelect.value === 'shell') {
                seqDisplay.textContent = cmdInput.value;
              } else if (typeSelect.value === 'http') {
                seqDisplay.textContent = `${methodInput.value.trim()} ${urlInput.value.trim()}`;
              } else {
                seqDisplay.textContent = seq.split(/\s+/).join(' + ');
              }
              button.dataset.seq = seq;
              button.dataset.type = typeSelect.value;
              button.dataset.method = methodInput.value.trim();
              button.dataset.url = urlInput.value.trim();
              button.dataset.body = bodyInput.value;
              button.dataset.effect = effectSelect.value;
              button.dataset.sound = soundInput.value.trim();
              button.dataset.critical = criticalCheck.checked;
            }
          })
          .catch(() => {});
        saveCurrent();
      });

      if (cmdInput) {
        cmdInput.addEventListener('change', () => {
          const cmd = cmdInput.value.trim();
          fetch(`/config/${id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              type: typeSelect.value,
              seq: seqInput.value.trim(),
              cmd,
              method: methodInput.value.trim(),
              url: urlInput.value.trim(),
              body: bodyInput.value,
              effect: effectSelect.value,
              sound: soundInput.value.trim(),
              critical: criticalCheck.checked
            })
          }).catch(() => {});
          if (typeSelect.value === 'shell') {
            seqDisplay.textContent = cmd;
          } else if (typeSelect.value === 'http') {
            seqDisplay.textContent = `${methodInput.value.trim()} ${urlInput.value.trim()}`;
          } else {
            seqDisplay.textContent = seqInput.value.split(/\s+/).join(' + ');
          }
          button.dataset.cmd = cmd;
          button.dataset.type = typeSelect.value;
          button.dataset.method = methodInput.value.trim();
          button.dataset.url = urlInput.value.trim();
          button.dataset.body = bodyInput.value;
          button.dataset.effect = effectSelect.value;
          button.dataset.sound = soundInput.value.trim();
          button.dataset.critical = criticalCheck.checked;
          saveCurrent();
        });
      }

      if (urlInput) {
        const updateHttp = () => {
          fetch(`/config/${id}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              type: typeSelect.value,
              seq: seqInput.value.trim(),
              cmd: cmdInput.value.trim(),
              method: methodInput.value.trim(),
              url: urlInput.value.trim(),
              body: bodyInput.value,
              effect: effectSelect.value,
              sound: soundInput.value.trim()
            })
          }).catch(() => {});
          if (typeSelect.value === 'http') {
            seqDisplay.textContent = `${methodInput.value.trim()} ${urlInput.value.trim()}`;
          }
          button.dataset.method = methodInput.value.trim();
          button.dataset.url = urlInput.value.trim();
          button.dataset.body = bodyInput.value;
          button.dataset.effect = effectSelect.value;
          button.dataset.sound = soundInput.value.trim();
          button.dataset.critical = criticalCheck.checked;
          saveCurrent();
        };
        urlInput.addEventListener('change', updateHttp);
        methodInput.addEventListener('change', updateHttp);
        bodyInput.addEventListener('change', updateHttp);
      }
    }

    function getIdList() {
      try {
        return JSON.parse(localStorage.getItem(storageKey('button_ids')) || 'null');
      } catch (e) {
        return null;
      }
    }

    function saveIdList(ids) {
      localStorage.setItem(storageKey('button_ids'), JSON.stringify(ids));
    }

    function cleanupUnusedConfigs(validIds) {
      const prefix = storageKey('config_');
      Object.keys(localStorage).forEach(k => {
        if (k.startsWith(prefix)) {
          const id = k.slice(prefix.length);
          if (!validIds.includes(id)) localStorage.removeItem(k);
        }
      });
    }

function generateId(existing) {
      let i = 1;
      while (existing.includes(String(i))) i++;
      return String(i);
    }

    function downloadCurrent() {
      fetch('/export')
        .then(r => r.json())
        .then(data => {
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'config.json';
          a.click();
          URL.revokeObjectURL(a.href);
        })
        .catch(() => alert('Error al exportar la configuración'));
    }

    function uploadConfigFile(file) {
      const reader = new FileReader();
      reader.onload = () => {
        let data;
        try {
          data = JSON.parse(reader.result);
        } catch (e) {
          alert('Archivo inválido');
          return;
        }
        fetch('/import', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        })
          .then(r => r.json())
          .then(resp => {
            if (resp.status === 'ok') {
              const ids = Object.keys(data);
              const current = getIdList() || [];
              current.forEach(id => {
                if (!ids.includes(id)) localStorage.removeItem(storageKey('config_' + id));
              });
              saveIdList(ids);
              ids.forEach(id => saveConfig(id, data[id]));
              location.reload();
            } else {
              alert('Error: ' + (resp.message || 'import failed'));
            }
          })
          .catch(() => alert('Error al enviar configuración'));
      };
      reader.readAsText(file);
    }

    let configContainer, grid;

    function addNewButton() {
      const ids = getIdList() || Object.keys(defaults);
      const newId = generateId(ids);
      ids.push(newId);
      saveIdList(ids);
      const cfg = { label: `Botón ${newId}`, seq: [], cmd: '', type: 'keys', image: '', color: '', bg: 'color', method: 'GET', url: '', body: '', effect: 'anim', sound: '', critical: false };
      saveConfig(newId, cfg);
      const button = createButton(newId, cfg);
      grid.appendChild(button);
      const form = createForm(newId, cfg);
      configContainer.appendChild(form);
      setupForm(form, button, newId);
    }

    window.addEventListener('DOMContentLoaded', () => {
      configContainer = document.getElementById('configContainer');
      grid = document.getElementById('buttonGrid');

      const profileSelect = document.getElementById('profileSelect');
      const newProfileBtn = document.getElementById('newProfileBtn');
      const deleteProfileBtn = document.getElementById('deleteProfileBtn');

      let profiles = getProfiles();
      if (!profiles) {
        profiles = ['default'];
        saveProfiles(profiles);
      }
      let current = getCurrentProfile();
      if (!profiles.includes(current)) {
        profiles.push(current);
        saveProfiles(profiles);
      }

      if (profileSelect) {
        profileSelect.innerHTML = profiles
          .map(p => `<option value="${p}"${p === current ? ' selected' : ''}>${p}</option>`)
          .join('');
        profileSelect.addEventListener('change', () => {
          setCurrentProfile(profileSelect.value);
          location.reload();
        });
      }

      if (newProfileBtn) {
        newProfileBtn.addEventListener('click', () => {
          const name = prompt('Nombre del perfil');
          if (!name) return;
          if (profiles.includes(name)) {
            alert('El perfil ya existe');
            return;
          }
          profiles.push(name);
          saveProfiles(profiles);
          setCurrentProfile(name);
          saveIdList(Object.keys(defaults));
          Object.keys(defaults).forEach(id => saveConfig(id, defaults[id]));
          location.reload();
        });
      }

      if (deleteProfileBtn) {
        deleteProfileBtn.addEventListener('click', () => {
          current = getCurrentProfile();
          if (current === 'default') {
            alert('No se puede eliminar el perfil por defecto');
            return;
          }
          if (!confirm('¿Eliminar perfil actual?')) return;
          const ids = getIdList() || [];
          ids.forEach(id => localStorage.removeItem(storageKey('config_' + id)));
          localStorage.removeItem(storageKey('button_ids'));
          profiles = profiles.filter(p => p !== current);
          saveProfiles(profiles);
          setCurrentProfile(profiles[0] || 'default');
          location.reload();
        });
      }

      const addBtn = document.getElementById('addButton');
      if (addBtn) addBtn.addEventListener('click', addNewButton);
      const exportBtn = document.getElementById('exportBtn');
      if (exportBtn) exportBtn.addEventListener('click', downloadCurrent);
      const importBtn = document.getElementById('importBtn');
      const importFile = document.getElementById('importFile');
      if (importBtn && importFile) {
        importBtn.addEventListener('click', () => importFile.click());
        importFile.addEventListener('change', () => {
          if (importFile.files.length) {
            uploadConfigFile(importFile.files[0]);
            importFile.value = '';
          }
        });
      }

      let ids = getIdList();
      if (!ids) {
        ids = Object.keys(defaults);
        saveIdList(ids);
      }
      cleanupUnusedConfigs(ids);

      ids.forEach(id => {
        const saved = loadConfig(id) || {};
        const def = defaults[id] || {};
        const cfg = {
          label: saved.label || def.label || `Botón ${id}`,
          image: saved.image !== undefined ? saved.image : def.image,
          color: saved.color !== undefined ? saved.color : def.color,
          seq: saved.seq ? saved.seq.trim().split(/\s+/) : (def.seq || []),
          cmd: saved.cmd !== undefined ? saved.cmd : (def.cmd || ''),
          method: saved.method || def.method || 'GET',
          url: saved.url !== undefined ? saved.url : (def.url || ''),
          body: saved.body !== undefined ? saved.body : (def.body || ''),
          type: saved.type || def.type || 'keys',
          bg: saved.bg || (saved.image ? 'image' : (saved.color ? 'color' : (def.image ? 'image' : 'color'))),
          effect: saved.effect || def.effect || 'anim',
          sound: saved.sound !== undefined ? saved.sound : (def.sound || ''),
          critical: saved.critical !== undefined ? saved.critical : (def.critical || false)
        };
        const button = createButton(id, cfg);
        grid.appendChild(button);
        const form = createForm(id, cfg);
        configContainer.appendChild(form);
        setupForm(form, button, id);
      });
    });

</script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-..." crossorigin="anonymous"></script>

</body>
</html>
